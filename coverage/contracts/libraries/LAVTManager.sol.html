<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/LAVTManager.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> LAVTManager.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>29/29</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>22/22</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>31/31</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">179×</span>
<span class="cline-any cline-yes">177×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">175×</span>
<span class="cline-any cline-yes">175×</span>
<span class="cline-any cline-yes">175×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">140×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">138×</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-yes">130×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">91×</span>
<span class="cline-any cline-yes">91×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">91×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">87×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">402×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">190×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">172×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">337×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">337×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">187×</span>
<span class="cline-any cline-yes">187×</span>
<span class="cline-any cline-yes">187×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">181×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.2;
&nbsp;
import "../interfaces/IAventusStorage.sol";
import "./LAventusTime.sol";
import "./LAVTStorage.sol";
import "./LAventusDLL.sol";
&nbsp;
// Library for adding functionality for handling AVT.
library LAVTManager  {
&nbsp;
  // See IAVTManager interface for logs description
  event LogAVTWithdrawn(address indexed sender, uint amount);
  event LogAVTDeposited(address indexed sender, uint amount);
&nbsp;
  function withdraw(IAventusStorage _storage, uint _amount)
    external
  {
    require(!votingIsInTheRevealPeriod(_storage, msg.sender), "Cannot withdraw until all votes are revealed");
    require(!avtIsLockedUpInDeposits(_storage, _amount, msg.sender), "Funds required by a deposit cannot be withdrawn");
&nbsp;
    decreaseAVT(_storage, msg.sender, _amount);
    _storage.transferAVTTo(msg.sender, _amount);
    emit LogAVTWithdrawn(msg.sender, _amount);
  }
&nbsp;
  function deposit(IAventusStorage _storage, uint _amount)
    external
  {
    require(!votingIsInTheRevealPeriod(_storage, msg.sender), "Cannot deposit until all votes are revealed");
&nbsp;
    increaseAVT(_storage, msg.sender, _amount);
    _storage.transferAVTFrom(msg.sender, _amount);
    emit LogAVTDeposited(msg.sender, _amount);
  }
&nbsp;
  function transfer(IAventusStorage _storage, uint _amount, address _toAddress)
    external
  {
    require(!votingIsInTheRevealPeriod(_storage, msg.sender), "Cannot transfer until all votes are revealed");
    require(!avtIsLockedUpInDeposits(_storage, _amount, msg.sender), "Funds required by a deposit cannot be transferred");
    require(!votingIsInTheRevealPeriod(_storage, _toAddress), "Cannot recieve transfers until all votes are revealed");
&nbsp;
    doTransfer(_storage, _amount, msg.sender, _toAddress);
  }
&nbsp;
  function lockDeposit(IAventusStorage _storage, address _account, uint _deposit)
    external
  {
    uint expectedDeposits = LAVTStorage.getExpectedDeposits(_storage, _account) + _deposit;
    uint currentBalance = getBalance(_storage, _account);
&nbsp;
    require(currentBalance &gt;= expectedDeposits, "Insufficient balance to cover deposits");
&nbsp;
    LAVTStorage.setExpectedDeposits(_storage, _account, expectedDeposits);
  }
&nbsp;
  function unlockDeposit(IAventusStorage _storage, address _account, uint _deposit)
    external
  {
    // DEBUG_ONLY assert(_deposit != 0);
    uint expectedDeposits = LAVTStorage.getExpectedDeposits(_storage, _account);
    // DEBUG_ONLY assert(expectedDeposits &gt;= _deposit);
    LAVTStorage.setExpectedDeposits(_storage, _account, expectedDeposits - _deposit);
  }
&nbsp;
  function getBalance(IAventusStorage _storage, address _account)
    public
    view
    returns (uint balance_)
  {
    balance_ = LAVTStorage.getAVTBalance(_storage, _account);
  }
&nbsp;
  function decreaseAVT(IAventusStorage _storage, address _account, uint _amount)
    public
  {
    LAVTStorage.decreaseAVT(_storage, _account, _amount);
  }
&nbsp;
  function increaseAVT(IAventusStorage _storage,  address _account, uint _amount)
    public
  {
    LAVTStorage.increaseAVT(_storage, _account, _amount);
  }
&nbsp;
  // NOTE: This version has NO CHECKS on whether the transfer should be blocked so should only be
  // used internally. Consider transfer() instead.
  function doTransfer(IAventusStorage _storage, uint _amount, address _fromAddress, address _toAddress)
    private
  {
    require(_amount != 0, "The amount of a transfer must be positive");
&nbsp;
    decreaseAVT(_storage, _fromAddress, _amount);
    increaseAVT(_storage, _toAddress, _amount);
  }
&nbsp;
  function votingIsInTheRevealPeriod(IAventusStorage _storage, address _account)
    private
    view
    returns (bool inReveal_)
  {
    uint revealTime = LAventusDLL.getHeadValue(_storage, _account);
&nbsp;
    if (revealTime == 0)
      inReveal_ = false; // No unrevealed votes
    else if (LAventusTime.getCurrentTime(_storage) &lt; revealTime)
      inReveal_ = false; // Voting still ongoing
    else
      inReveal_ = true; // Reveal period active (even if reveal is over tokens are blocked until reveal)
  }
&nbsp;
  function avtIsLockedUpInDeposits(IAventusStorage _storage, uint _amount, address _account)
    private
    view
    returns (bool lockedInDeposits_)
  {
    uint expectedDeposits = LAVTStorage.getExpectedDeposits(_storage, _account);
    uint currentBalance = getBalance(_storage, _account);
    require(_amount &lt;= currentBalance, "Amount taken must be less than current balance");
    // If taking this amount of AVT out will mean we don't have enough deposits then block the withdrawl.
    lockedInDeposits_ = currentBalance - _amount &lt; expectedDeposits;
  }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Feb 28 2019 12:07:39 GMT+0000 (GMT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>

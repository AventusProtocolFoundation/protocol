<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\libraries\LEventsEnact.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> LEventsEnact.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>42/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>27/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>22/22</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>73/73</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">229×</span>
<span class="cline-any cline-yes">185×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">186×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">172×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">207×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">175×</span>
<span class="cline-any cline-yes">175×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">159×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-yes">205×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-yes">203×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">138×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">126×</span>
<span class="cline-any cline-yes">126×</span>
<span class="cline-any cline-yes">126×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">126×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-yes">443×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "./LEventsCommon.sol";
&nbsp;
library LEventsEnact {
  modifier onlyEventOwnerOrPrimaryDelegate(IAventusStorage _storage, uint _eventId, address _eventOwnerOrDelegate) {
    LEventsCommon.checkOwnerOrDelegateByRole(_storage, _eventId, _eventOwnerOrDelegate, "primary");
    _;
  }
&nbsp;
  modifier onlyEventOwnerOrSecondaryDelegate(IAventusStorage _storage, uint _eventId, address _eventOwnerOrDelegate) {
    LEventsCommon.checkOwnerOrDelegateByRole(_storage, _eventId, _eventOwnerOrDelegate, "secondary");
    _;
  }
&nbsp;
  modifier ticketIsRefundableOrResellable(IAventusStorage _storage, uint _eventId, uint _ticketId) {
    require(
      eventActive(_storage, _eventId),
      "Event must be active"
    );
    require(
      !isTicketRefunded(_storage, _eventId, _ticketId),
      "Ticket must not have been refunded yet"
    );
    require(
      _ticketId != 0 &amp;&amp; _ticketId &lt;= _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "TicketCount"))),
      "Ticket's Id must be valid"
    );
    _;
  }
&nbsp;
  modifier isActiveEvent(IAventusStorage _storage, uint _eventId) {
    require(
      eventActive(_storage, _eventId),
      "Event must be active"
    );
    _;
  }
&nbsp;
  modifier isInactiveEvent(IAventusStorage _storage, uint _eventId) {
    require(
      !eventActive(_storage, _eventId),
      "Event must be inactive"
    );
    _;
  }
&nbsp;
  modifier isValidEvent(IAventusStorage _storage, uint _eventId) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(
      LEventsCommon.eventValid(_storage, _eventId),
      "Event must be valid"
    );
    _;
  }
&nbsp;
  modifier inTicketSalePeriod (IAventusStorage _storage, uint _eventId) {
    uint currentTime = LAventusTime.getCurrentTime(_storage);
    require(
      currentTime &lt; _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "eventTime"))),
      "Current date must be before event's date"
    );
    require(
      currentTime &gt;= _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "ticketSaleStartTime"))),
      "Current date must be after beginning of tickets sale period"
    );
    _;
  }
&nbsp;
  modifier ticketSaleNotInProgress(IAventusStorage _storage, uint _eventId) {
    uint ticketCount = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "TicketCount")));
    uint refundedTicketCount = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "RefundedTicketCount")));
    require(
      ticketCount == refundedTicketCount,
      "All sold tickets must have been refunded"
    );
    _;
  }
&nbsp;
  modifier isNotUnderChallenge(IAventusStorage _storage, uint _eventId) {
    require(
      LEventsCommon.eventIsNotUnderChallenge(_storage, _eventId),
      "Event must not be under challenge"
    );
    _;
  }
&nbsp;
  /**
  * @dev Refund sale of a ticket
  * @param _storage Storage contract
  * @param _eventId event id for the event in context
  * @param _ticketId ticket Id for the ticket to be refunded
  * @param _eventOwnerOrDelegate address requesting this refund - must be event owner or delegate
  */
  function doRefundTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, address _eventOwnerOrDelegate)
    external
    onlyEventOwnerOrPrimaryDelegate(_storage, _eventId, _eventOwnerOrDelegate)
    ticketIsRefundableOrResellable(_storage, _eventId, _ticketId)
  {
    bytes32 refundTicketKey = keccak256(abi.encodePacked("Event", _eventId, "RefundedTicketCount"));
    uint refundedTicketCount = _storage.getUInt(refundTicketKey);
    _storage.setUInt(refundTicketKey, refundedTicketCount + 1);
    setTicketStatusRefunded(_storage, _eventId, _ticketId);
    bytes32 ticketHash = _storage.getBytes32(keccak256(abi.encodePacked("Event", _eventId, "Ticket", _ticketId, "ticketHash")));
    setTicketHashNotOwned(_storage, ticketHash);
  }
&nbsp;
  /**
  * @dev Executes Cancellation of an existing event.
  * @param _storage Storage contract
  * @param _eventId - id of the event to cancel
  */
  function doCancelEvent(IAventusStorage _storage, uint _eventId)
    external
    isActiveEvent(_storage, _eventId)
    isNotUnderChallenge(_storage, _eventId)
    ticketSaleNotInProgress(_storage, _eventId)
  {
    setEventStatusCancelled(_storage, _eventId);
    doUnlockEventDeposit(_storage, _eventId);
  }
&nbsp;
  /**
  * @dev Resell tickets for an active event.
  * @param _storage Storage contract
  * @param _eventId - event id for the event in context
  * @param _ticketId - original ticketId
  * @param _newBuyer - address of the ticket buyer
  * @param _eventOwnerOrDelegate address requesting this sale - must be event owner or delegate
  *
  * TODO: Could be external but too many variables for stack unless public
  */
  function doResellTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, address _newBuyer, address _eventOwnerOrDelegate)
    external
    onlyEventOwnerOrSecondaryDelegate(_storage, _eventId, _eventOwnerOrDelegate)
    inTicketSalePeriod(_storage, _eventId)
    ticketIsRefundableOrResellable(_storage, _eventId, _ticketId)
  {
    _storage.setAddress(keccak256(abi.encodePacked("Event", _eventId, "Ticket", _ticketId, "buyer")), _newBuyer);
  }
&nbsp;
  /**
  * @dev Create an event
  * @param _storage Storage contract
  * @param _eventDesc description or title of the event
  * @param _eventTime - the actual event time
  * @param _capacity - number of tickets (capacity) for the event
  * @param _averageTicketPriceInUSCents  - average ticket price in US Cents
  * @param _ticketSaleStartTime - expected ticket sale start time
  * @param _eventSupportURL - verifiable official supporting url for the event
  * @param _owner - address of the event owner
  * @return uint eventId_ of newly created event
  *
  * TODO: Could be external but too many variables for stack unless public
  */
  function doCreateEvent(IAventusStorage _storage, string _eventDesc, uint _eventTime, uint _capacity,
    uint _averageTicketPriceInUSCents, uint _ticketSaleStartTime, string _eventSupportURL, address _owner)
    public
    returns (uint eventId_)
  {
    LEventsCommon.validateEventCreation(_storage, _eventDesc, _eventTime, _capacity, _averageTicketPriceInUSCents, _ticketSaleStartTime, _eventSupportURL, _owner);
&nbsp;
    eventId_ = _storage.getUInt(LEventsCommon.getEventCountKey()) + 1;
&nbsp;
    uint depositInUSCents = 0;
    uint depositInAVTDecimals = 0;
    (depositInUSCents, depositInAVTDecimals) =
      LEventsCommon.getEventDeposit(_storage, _capacity, _averageTicketPriceInUSCents, _ticketSaleStartTime);
&nbsp;
    bytes32 key = keccak256(abi.encodePacked("ExpectedDeposits", _owner));
    _storage.setUInt(key, _storage.getUInt(key) + depositInAVTDecimals);
    require(
      _storage.getUInt(key) &lt;= LAVTManager.getBalance(_storage, _owner, "deposit"),
      "Insufficient deposit funds to create event"
    );
&nbsp;
    _storage.setUInt(LEventsCommon.getEventCountKey(), eventId_);
    _storage.setAddress(keccak256(abi.encodePacked("Event", eventId_, "owner")), _owner);
    _storage.setUInt(keccak256(abi.encodePacked("Event", eventId_, "capacity")), _capacity);
    _storage.setUInt(keccak256(abi.encodePacked("Event", eventId_, "ticketSaleStartTime")), _ticketSaleStartTime);
    _storage.setString(keccak256(abi.encodePacked("Event", eventId_, "eventSupportURL")), _eventSupportURL);
    _storage.setUInt(keccak256(abi.encodePacked("Event", eventId_, "deposit")), depositInAVTDecimals);
    _storage.setUInt(keccak256(abi.encodePacked("Event", eventId_, "eventTime")), _eventTime);
  }
&nbsp;
  function doUnlockEventDeposit(IAventusStorage _storage, uint _eventId)
    public
    isInactiveEvent(_storage, _eventId)
  {
    address owner = LEventsCommon.getEventOwner(_storage, _eventId);
    bytes32 key = keccak256(abi.encodePacked("ExpectedDeposits", owner));
    uint depositInAVT = LEventsCommon.getExistingEventDeposit(_storage, _eventId);
    require(
      depositInAVT != 0,
      "Unlocked event must have a positive deposit"
    );
    <span class="missing-if-branch" title="else path not taken" >E</span>assert(_storage.getUInt(key) &gt;= depositInAVT);
    _storage.setUInt(key, _storage.getUInt(key) - depositInAVT);
    _storage.setUInt(keccak256(abi.encodePacked("Event", _eventId, "deposit")), 0);
  }
&nbsp;
  /**
  * @dev Sell tickets for an active event.
  * @param _storage Storage contract
  * @param _eventId - event id for the event in context
  * @param _ticketDetails - ticket details
  * @param _buyer - address of the ticket buyer
  * @param _eventOwnerOrDelegate address requesting this sale - must be event owner or delegate
  *
  * TODO: Consider adding ticket price so we can stop selling tickets when the total capital has been reached.
  * TODO: Could be external but too many variables for stack unless public
  */
  function doSellTicket(IAventusStorage _storage, uint _eventId, string _ticketDetails, address _buyer, address _eventOwnerOrDelegate)
    public
    onlyEventOwnerOrPrimaryDelegate(_storage, _eventId, _eventOwnerOrDelegate)
    inTicketSalePeriod(_storage, _eventId)
    isActiveEvent(_storage, _eventId)
    returns (uint ticketId_)
  {
    // TODO: Convert to a modifier when variable stack depth allows.
    ticketId_ = LEventsCommon.checkEventOverCapacity(_storage, _eventId);
&nbsp;
    bytes32 ticketHash = keccak256(abi.encodePacked("Event", _eventId, "Ticket", _ticketDetails));
    setTicketHashOwned(_storage, ticketHash);
&nbsp;
    _storage.setUInt(keccak256(abi.encodePacked("Event", _eventId, "TicketCount")), ticketId_);
    _storage.setBytes32(keccak256(abi.encodePacked("Event", _eventId, "Ticket", ticketId_, "ticketHash")), ticketHash);
    _storage.setAddress(keccak256(abi.encodePacked("Event", _eventId, "Ticket", ticketId_, "buyer")), _buyer);
  }
&nbsp;
  function setTicketStatusRefunded(IAventusStorage _storage, uint _eventId, uint _ticketId) private {
    _storage.setUInt(keccak256(abi.encodePacked("Event", _eventId, "Ticket", _ticketId, "status")), 1);
  }
&nbsp;
  function setTicketHashOwned(IAventusStorage _storage, bytes32 _hash) private {
    require(
      !ticketHashIsOwned(_storage, _hash),
      "This hash must not yet be owned"
    );
    _storage.setBoolean(_hash, true);
  }
&nbsp;
  function setTicketHashNotOwned(IAventusStorage _storage, bytes32 _hash) private {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(
      ticketHashIsOwned(_storage, _hash),
      "This ticket hash must already be owned"
    );
    _storage.setBoolean(_hash, false);
  }
&nbsp;
  function setEventStatusCancelled(IAventusStorage _storage, uint _eventId) private {
    _storage.setUInt(keccak256(abi.encodePacked("Event", _eventId, "status")), 1);
  }
&nbsp;
  function eventActive(IAventusStorage _storage, uint _eventId)
    private
    view
    isValidEvent(_storage, _eventId)
    returns (bool active_)
  {
    bool eventHasHappened = LAventusTime.getCurrentTime(_storage) &gt;=  _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "eventTime")));
    bool eventIsCancelled = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "status"))) == 1;
    bool eventIsFraudulent = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "status"))) == 2;
    active_ = !eventHasHappened &amp;&amp; !eventIsCancelled &amp;&amp; !eventIsFraudulent;
  }
&nbsp;
  function isTicketRefunded(IAventusStorage _storage, uint _eventId, uint _ticketId) private view returns (bool refunded_) {
    refunded_ = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "Ticket", _ticketId, "status"))) == 1;
  }
&nbsp;
  function ticketHashIsOwned(IAventusStorage _storage, bytes32 _hash) private view returns (bool hashOwned_) {
    hashOwned_ = _storage.getBoolean(_hash);
  }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jul 18 2018 15:18:55 GMT+0100 (GMT Daylight Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>

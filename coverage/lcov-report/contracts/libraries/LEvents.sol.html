<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/LEvents.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> LEvents.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>25/25</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>10/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>30/30</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71×</span>
<span class="cline-any cline-yes">61×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">84×</span>
<span class="cline-any cline-yes">84×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.2;
&nbsp;
import "../interfaces/IAventusStorage.sol";
import "./LAventusTime.sol";
import "./LEventsEvents.sol";
import "./LEventsRoles.sol";
import "./LEventsTickets.sol";
import "./LMerkleRoots.sol";
import "./LEventsStorage.sol";
import "./zeppelin/LECRecovery.sol";
&nbsp;
/* @dev All external methods in here are called from EventsManager and have the same function signature (and interface
 * documentation) as their namesakes in EventsManager. Each of these methods should do the following and ONLY the following:
 *   - check that the event is in the correct state
 *   - call the method of the same name in a sublibrary to actually make the required change
 *   - emit the correct log
 * In particular, the methods SHOULD NOT check proofs or msg.sender validity - these checks should be done in the sublibrary.
 */
&nbsp;
library LEvents {
&nbsp;
  enum EventState {NonExistent, Trading, Inactive}
&nbsp;
  // See IEventsManager interface for logs description
  event LogEventCreated(uint indexed eventId, address indexed eventOwner, string eventDesc, uint offSaleTime);
  event LogTicketSold(uint indexed eventId, uint indexed ticketId, bytes32 vendorTicketRefHash, string ticketMetadata,
      address indexed buyer);
  event LogTicketCancelled(uint indexed eventId, uint indexed ticketId, bytes vendorProof);
  event LogTicketResold(uint indexed eventId, uint indexed ticketId, bytes resellerProof, bytes doorData,
      address indexed newBuyer);
  event LogTicketListed(uint indexed eventId, uint ticketId, address indexed ticketOwner, bytes32 indexed leafHash);
  event LogRoleRegisteredOnEvent(uint indexed eventId, address indexed roleAddress, string role);
&nbsp;
  modifier onlyWhenTrading(IAventusStorage _storage, uint _eventId) {
    require(EventState.Trading == getEventState(_storage, _eventId), "Event must be trading");
    _;
  }
&nbsp;
  modifier onlyWhenExistent(IAventusStorage _storage, uint _eventId) {
    require(EventState.NonExistent != getEventState(_storage, _eventId), "Event must exist");
    _;
  }
&nbsp;
  function createEvent(IAventusStorage _storage, string calldata _eventDesc, uint _eventTime, uint _offSaleTime,
      bytes calldata _createEventOwnerProof)
    external
  {
    (address eventOwner, uint eventId) = LEventsEvents.createEvent(_storage, _eventDesc, _eventTime, _offSaleTime,
        _createEventOwnerProof);
    emit LogEventCreated(eventId, eventOwner, _eventDesc, _offSaleTime);
  }
&nbsp;
  function sellTicket(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash,
      string calldata _ticketMetadata, address _buyer)
    external
    onlyWhenTrading(_storage, _eventId)
  {
    uint ticketId = LEventsTickets.sellTicket(_storage, _eventId, _vendorTicketRefHash, _buyer);
    emit LogTicketSold(_eventId, ticketId, _vendorTicketRefHash, _ticketMetadata, _buyer);
  }
&nbsp;
  function cancelTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, bytes calldata _cancelTicketVendorProof)
    external
    onlyWhenTrading(_storage, _eventId)
  {
    LEventsTickets.cancelTicket(_storage, _eventId, _ticketId, _cancelTicketVendorProof);
    emit LogTicketCancelled(_eventId, _ticketId, _cancelTicketVendorProof);
  }
&nbsp;
  function resellTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, bytes calldata _resellTicketTicketOwnerProof,
      address _newBuyer, bytes calldata _resellTicketResellerProof, bytes calldata _doorData)
    external
    onlyWhenTrading(_storage, _eventId)
  {
    LEventsTickets.resellTicket(_storage, _eventId, _ticketId, _resellTicketTicketOwnerProof, _newBuyer,
        _resellTicketResellerProof);
    emit LogTicketResold(_eventId, _ticketId, _resellTicketResellerProof, _doorData, _newBuyer);
  }
&nbsp;
  function listTicketA(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash, string calldata _ticketMetadata,
      bytes calldata _listTicketVendorProof, bytes calldata _doorData, bytes calldata _listTicketTicketOwnerProof)
    external
  {
    // Leaf hash and owner are stored temporarily to enable listTicketA/B/C split.
    address ticketOwner = LECRecovery.recover(_vendorTicketRefHash, _listTicketTicketOwnerProof);
    bytes32 leafHash = keccak256(abi.encodePacked(_eventId, _vendorTicketRefHash, _ticketMetadata, ticketOwner,
        _listTicketVendorProof, _doorData));
    LEventsStorage.setTemporaryLeafHashAndOwner(_storage, _eventId, _vendorTicketRefHash, leafHash, ticketOwner);
  }
&nbsp;
  function listTicketB(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash, bytes32[] calldata _merklePath)
    external
    view
    onlyWhenTrading(_storage, _eventId)
  {
    bytes32 leafHash = LEventsStorage.getLeafHash(_storage, _eventId, _vendorTicketRefHash);
    bytes32 rootHash = LMerkleRoots.generateMerkleRoot(_storage, _merklePath, leafHash);
    require(LMerkleRoots.merkleRootIsActive(_storage, rootHash), "Merkle root is not active");
  }
&nbsp;
  function listTicketC(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash,
      bytes calldata _listTicketVendorProof)
    external
  {
    bytes32 leafHash = LEventsStorage.getLeafHash(_storage, _eventId, _vendorTicketRefHash);
    address ticketOwner = LEventsStorage.getLeafHashOwner(_storage, leafHash);
    uint ticketId = LEventsTickets.listTicket(_storage, _eventId, _vendorTicketRefHash, ticketOwner, _listTicketVendorProof);
    emit LogTicketListed(_eventId, ticketId, ticketOwner, leafHash);
&nbsp;
    LEventsStorage.clearTemporaryLeafHashAndOwner(_storage, _eventId, _vendorTicketRefHash);
  }
&nbsp;
  function registerRoleOnEvent(IAventusStorage _storage, uint _eventId, address _roleAddress, string calldata _role)
    external
    onlyWhenExistent(_storage, _eventId)
  {
    LEventsRoles.registerRoleOnEvent(_storage, _eventId, _roleAddress, _role);
    emit LogRoleRegisteredOnEvent(_eventId, _roleAddress, _role);
  }
&nbsp;
  function getEventState(IAventusStorage _storage, uint _eventId) private view returns (EventState) {
    address eventOwner = LEventsStorage.getEventOwner(_storage, _eventId);
    if (eventOwner == address(0)) return EventState.NonExistent;
&nbsp;
    uint currentTime = LAventusTime.getCurrentTime(_storage);
    if (currentTime &gt;= LEventsStorage.getOffSaleTime(_storage, _eventId)) return EventState.Inactive;
&nbsp;
    return EventState.Trading;
  }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jan 21 2019 16:59:59 GMT+0000 (GMT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/LEventsTickets.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> LEventsTickets.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>35/35</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>24/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>14/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>45/45</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.2;
&nbsp;
import "../interfaces/IAventusStorage.sol";
import "./LAventusTime.sol";
import "./LEventsRoles.sol";
import "./LEventsStorage.sol";
import "./LMembers.sol";
import "./zeppelin/LECRecovery.sol";
&nbsp;
library LEventsTickets {
  modifier onlyActiveTicket(IAventusStorage _storage, uint _eventId, uint _ticketId) {
    require(ticketIsActive(_storage, _eventId, _ticketId), "Ticket must be active");
    _;
  }
&nbsp;
  modifier onlyValidatorOrVendorOnEvent(IAventusStorage _storage, uint _eventId) {
    require(LEventsRoles.isValidatorOrVendorOnEvent(_storage, _eventId, msg.sender),
        "Sender must be validator or vendor on event");
    _;
  }
&nbsp;
  modifier onlyValidatorOrResellerOnEvent(IAventusStorage _storage, uint _eventId) {
    require(LEventsRoles.isValidatorOrResellerOnEvent(_storage, _eventId, msg.sender),
        "Sender must be validator or reseller on event");
    _;
  }
&nbsp;
  modifier onlyVendorOnEvent(IAventusStorage _storage, uint _eventId) {
    require(LEventsRoles.isVendorOnEvent(_storage, _eventId, msg.sender), "Sender must be vendor on event");
    _;
  }
&nbsp;
  function cancelTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, bytes calldata _cancelTicketVendorProof)
    external
    onlyValidatorOrVendorOnEvent(_storage, _eventId)
    onlyActiveTicket(_storage, _eventId, _ticketId)
  {
    address ticketOwner = LEventsStorage.getTicketOwner(_storage, _eventId, _ticketId);
    bytes32 cancelTicketHash = keccak256(abi.encodePacked(_eventId, _ticketId, ticketOwner));
    address vendor = LECRecovery.recover(cancelTicketHash, _cancelTicketVendorProof);
    require(LEventsRoles.isVendorOnEvent(_storage, _eventId, vendor), "Proof must be valid and signed by vendor");
    blockTicket(_storage, _eventId, _ticketId);  // Separate method: stack too deep.
&nbsp;
    if (!LEventsRoles.isVendorOnEvent(_storage, _eventId, msg.sender)) {
      LMembers.checkValidatorActiveAndRecordInteraction(_storage);
    }
  }
&nbsp;
  function resellTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, bytes calldata _resellTicketTicketOwnerProof,
      address _newBuyer, bytes calldata _resellTicketResellerProof)
    external
    onlyValidatorOrResellerOnEvent(_storage, _eventId)
    onlyActiveTicket(_storage, _eventId, _ticketId)
  {
    doResellTicket(_storage, _eventId, _ticketId, _resellTicketTicketOwnerProof, _newBuyer, _resellTicketResellerProof);
&nbsp;
    if (!LEventsRoles.isResellerOnEvent(_storage, _eventId, msg.sender)) {
      LMembers.checkValidatorActiveAndRecordInteraction(_storage);
    }
  }
&nbsp;
  function sellTicket(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash, address _ticketOwner)
    external
    onlyVendorOnEvent(_storage, _eventId)
    returns (uint ticketId_)
  {
    ticketId_ = addTicket(_storage, _eventId, _vendorTicketRefHash, _ticketOwner, msg.sender);
  }
&nbsp;
  function listTicket(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash, address _ticketOwner,
      bytes calldata _vendorProof)
    external
    onlyValidatorOrVendorOnEvent(_storage, _eventId)
    returns (uint ticketId_)
  {
    bytes32 blankHash = keccak256(abi.encodePacked(_eventId, _vendorTicketRefHash));
    bytes32 integratedHash = keccak256(abi.encodePacked(_eventId, _vendorTicketRefHash, _ticketOwner));
    address vendor = getSignerAndValidateProof(_storage, _eventId, "Primary", _vendorProof, blankHash, integratedHash);
&nbsp;
    ticketId_ = addTicket(_storage, _eventId, _vendorTicketRefHash, _ticketOwner, vendor);
&nbsp;
    if (!LEventsRoles.isVendorOnEvent(_storage, _eventId, msg.sender)) {
      LMembers.checkValidatorActiveAndRecordInteraction(_storage);
    }
  }
&nbsp;
  function doResellTicket(IAventusStorage _storage, uint _eventId, uint _ticketId, bytes memory _resellTicketTicketOwnerProof,
      address _newBuyer, bytes memory _resellTicketResellerProof)
    private
  {
    resellTicketOwnerPermissionCheck(_storage, _eventId, _ticketId, _resellTicketTicketOwnerProof);
&nbsp;
    bytes32 blankHash = keccak256(abi.encodePacked(_eventId, _ticketId, _resellTicketTicketOwnerProof));
    bytes32 integratedHash = keccak256(abi.encodePacked(_eventId, _ticketId, _resellTicketTicketOwnerProof,_newBuyer));
    getSignerAndValidateProof(_storage, _eventId, "Secondary", _resellTicketResellerProof, blankHash, integratedHash);
&nbsp;
    LEventsStorage.setTicketOwner(_storage, _eventId, _ticketId, _newBuyer);
  }
&nbsp;
  function getSignerAndValidateProof(IAventusStorage _storage, uint _eventId, string memory _role, bytes memory _proof,
      bytes32 _blankHash, bytes32 _integratedHash)
    private
    view
    returns (address signer_)
  {
    signer_ = LECRecovery.recover(_blankHash, _proof);
    if (!LEventsRoles.isTraderOnEvent(_storage, _eventId, signer_, _role)) {
      signer_ = LECRecovery.recover(_integratedHash, _proof);
    }
&nbsp;
    require(LEventsRoles.isTraderOnEvent(_storage, _eventId, signer_, _role),
        string(abi.encodePacked("Invalid ", _role, " proof")));
  }
&nbsp;
  function resellTicketOwnerPermissionCheck(IAventusStorage _storage, uint _eventId, uint _ticketId,
      bytes memory _ticketOwnerPermission)
   private
   view {
    address ticketOwner = LEventsStorage.getTicketOwner(_storage, _eventId, _ticketId);
    bytes32 msgHash = keccak256(abi.encodePacked(_eventId, _ticketId, ticketOwner));
    address signer = LECRecovery.recover(msgHash, _ticketOwnerPermission);
    require(signer == ticketOwner, "Resale must be signed by current owner");
  }
&nbsp;
  function addTicket(IAventusStorage _storage, uint _eventId, bytes32 _vendorTicketRefHash, address _ticketOwner,
      address _vendor)
    private
    returns (uint ticketId_)
  {
    // the vendor address is appended to ensure uniqueness if different vendors pass the same ticket ref
    ticketId_ = uint(keccak256(abi.encodePacked(_vendorTicketRefHash, _vendor)));
    require(!ticketIsActive(_storage, _eventId, ticketId_), "Ticket must not already be active");
    LEventsStorage.setTicketOwner(_storage, _eventId, ticketId_, _ticketOwner);
  }
&nbsp;
  function ticketIsActive(IAventusStorage _storage, uint _eventId, uint _ticketId) private view
    returns (bool isActive_)
  {
    address ticketOwner = LEventsStorage.getTicketOwner(_storage, _eventId, _ticketId);
    isActive_ = ticketOwner != address(0);
  }
&nbsp;
  function blockTicket(IAventusStorage _storage, uint _eventId, uint _ticketId)
    private
  {
    address eventOwner = LEventsStorage.getEventOwner(_storage, _eventId);
    // Set the ticket owner to the event owner to 'block' the ticket if it exists on a merkle tree
    LEventsStorage.setTicketOwner(_storage, _eventId, _ticketId, eventOwner);
  }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jan 21 2019 16:59:59 GMT+0000 (GMT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>

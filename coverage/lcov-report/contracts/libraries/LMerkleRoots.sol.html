<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/LMerkleRoots.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> LMerkleRoots.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>50/50</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>16/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>69/69</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">67×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">142×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.2;
&nbsp;
import "../interfaces/IAventusStorage.sol";
import "./LMembers.sol";
import "./LMerkleRootsStorage.sol";
import "./LAventusTime.sol";
import "./LAVTManager.sol";
&nbsp;
library LMerkleRoots {
&nbsp;
  // See IMerkleRootsManager interface for logs description
  event LogMerkleRootRegistered(address indexed ownerAddress, bytes32 indexed rootHash, uint treeDepth,
      uint lastEventTime);
  event LogMerkleRootDeregistered(bytes32 indexed rootHash);
  event LogMerkleRootAutoChallenged(address indexed challenger, bytes32 indexed rootHash);
&nbsp;
  modifier onlyActiveValidator(IAventusStorage _storage) {
    require(LMembers.memberIsActive(_storage, msg.sender, "Validator"), "Sender must be an active validator");
    _;
  }
&nbsp;
  modifier onlyIfNotAlreadyActive(IAventusStorage _storage, bytes32 _rootHash) {
    require(!merkleRootIsActive(_storage, _rootHash), "Merkle root is already active");
    _;
  }
&nbsp;
  modifier onlyActive(IAventusStorage _storage, bytes32 _rootHash) {
    require(merkleRootIsActive(_storage, _rootHash), "Merkle root must be active");
    _;
  }
&nbsp;
  modifier onlyAfterCoolingOffPeriod(IAventusStorage _storage, bytes32 _rootHash) {
    uint lastEventTime = LMerkleRootsStorage.getLastEventTime(_storage, _rootHash);
    uint currentTime = LAventusTime.getCurrentTime(_storage);
    uint coolingOffPeriod = LMerkleRootsStorage.getCoolingOffPeriod(_storage);
    // Avoid underflow
    require(currentTime &gt; lastEventTime &amp;&amp; currentTime - lastEventTime &gt;= coolingOffPeriod, "Must be after cooling off period");
    _;
  }
&nbsp;
  modifier onlyValidTreeDepth(IAventusStorage _storage, uint _treeDepth) {
    require(_treeDepth &gt; 0, "Tree depth cannot be zero");
    require(_treeDepth &lt;= LMerkleRootsStorage.getMaxTreeDepth(_storage),
        "Tree depth must not exceed the maximum allowed value");
    _;
  }
&nbsp;
  function registerMerkleRoot(IAventusStorage _storage, bytes32 _rootHash, uint _treeDepth, uint _lastEventTime)
    external
    onlyActiveValidator(_storage)
    onlyIfNotAlreadyActive(_storage, _rootHash)
  {
    uint deposit = getNewMerkleRootDeposit(_storage, _treeDepth, _lastEventTime);
    LAVTManager.lockDeposit(_storage, msg.sender, deposit);
&nbsp;
    LMerkleRootsStorage.setRootHashOwner(_storage, _rootHash, msg.sender);
    LMerkleRootsStorage.setTreeDepth(_storage, _rootHash, _treeDepth);
    LMerkleRootsStorage.setDeposit(_storage, _rootHash, deposit);
    setLastEventTime(_storage, _rootHash, _lastEventTime);
&nbsp;
    emit LogMerkleRootRegistered(msg.sender, _rootHash, _treeDepth, _lastEventTime);
  }
&nbsp;
  // TODO: Consider making this possible only if the validator is active
  function deregisterMerkleRoot(IAventusStorage _storage, bytes32 _rootHash)
    external
    onlyActive(_storage, _rootHash)
    onlyAfterCoolingOffPeriod(_storage, _rootHash)
  {
    uint deposit = LMerkleRootsStorage.getDeposit(_storage, _rootHash);
    address rootHashOwner = LMerkleRootsStorage.getRootHashOwner(_storage, _rootHash);
    LMerkleRootsStorage.setRootHashOwner(_storage, _rootHash, address(0));
    LMerkleRootsStorage.setDeposit(_storage, _rootHash, 0);
&nbsp;
    LAVTManager.unlockDeposit(_storage, rootHashOwner, deposit);
    emit LogMerkleRootDeregistered(_rootHash);
  }
&nbsp;
  function autoChallengeTreeDepth(IAventusStorage _storage, bytes32 _leafHash, bytes32[] calldata _merklePath)
    external
  {
    bytes32 rootHash = generateMerkleRoot(_storage, _merklePath, _leafHash);
    require(merkleRootIsActive(_storage, rootHash), "Merkle root must be active");
    require(LMerkleRootsStorage.getTreeDepth(_storage, rootHash) &lt; _merklePath.length + 1,
        "Challenged leaf must exist at a greater depth than declared by validator");
&nbsp;
    finaliseAutoChallenge(_storage, rootHash);
    LMerkleRootsStorage.setTreeDepth(_storage, rootHash, _merklePath.length + 1);
    emit LogMerkleRootAutoChallenged(msg.sender, rootHash);
  }
&nbsp;
  function autoChallengeLastEventTime(IAventusStorage _storage, uint _eventId, bytes calldata _remainingLeafData,
      bytes32[] calldata _merklePath)
    external
  {
    bytes32 rootHash = generateMerkleRoot(_storage, _merklePath, keccak256(abi.encodePacked(_eventId, _remainingLeafData)));
    require(merkleRootIsActive(_storage, rootHash), "Merkle root must be active");
    uint eventTime = getEventTime(_storage, _eventId);
    require(eventTime != 0 &amp;&amp; eventTime &gt; LMerkleRootsStorage.getLastEventTime(_storage, rootHash),
        "Challenged leaf must have a later event time than declared by validator");
&nbsp;
    finaliseAutoChallenge(_storage, rootHash);
    setLastEventTime(_storage, rootHash, eventTime);
    emit LogMerkleRootAutoChallenged(msg.sender, rootHash);
  }
&nbsp;
  function getNewMerkleRootDeposit(IAventusStorage _storage, uint _treeDepth, uint _lastEventTime)
    public
    view
    onlyValidTreeDepth(_storage, _treeDepth)
    returns (uint deposit_)
  {
    uint currentTime = LAventusTime.getCurrentTime(_storage);
    require(currentTime &lt; _lastEventTime, "Last event time must be in the future");
&nbsp;
    uint interveningEventTime = _lastEventTime - currentTime;
    require(interveningEventTime &lt;= LMerkleRootsStorage.getMaxInterveningEventTime(_storage),
      "Last event time must not exceed the maximum allowed value");
&nbsp;
    uint baseDeposit = LMerkleRootsStorage.getBaseDeposit(_storage);
    uint multiplier = LMerkleRootsStorage.getDepositMultiplier(_storage);
    // Overflow is avoided by checks on the input variables
    deposit_ = max(baseDeposit, (_treeDepth * interveningEventTime * multiplier));
  }
&nbsp;
  function merkleRootIsActive(IAventusStorage _storage, bytes32 _rootHash)
    public
    view
    returns (bool merkleRootIsActive_)
  {
    merkleRootIsActive_ = LMerkleRootsStorage.getRootHashOwner(_storage, _rootHash) != address(0);
  }
&nbsp;
  // NOTE: IAventusStorage is not used here but is required for proxying
  function generateMerkleRoot(IAventusStorage, bytes32[] memory _merklePath, bytes32 _leafHash)
    public
    pure
    returns (bytes32 rootHash_)
  {
    bytes32 computedHash = _leafHash;
&nbsp;
    for (uint i = 0; i &lt; _merklePath.length; i++) {
      bytes32 pathElement = _merklePath[i];
&nbsp;
      if (computedHash &lt; pathElement) {
        // Hash(current computed hash + current path element)
        computedHash = keccak256(abi.encodePacked(computedHash, pathElement));
      } else {
        // Hash(current element of the path + current computed hash)
        computedHash = keccak256(abi.encodePacked(pathElement, computedHash));
      }
    }
    rootHash_ = computedHash;
  }
&nbsp;
  function finaliseAutoChallenge(IAventusStorage _storage, bytes32 _rootHash)
    private
  {
    uint deposit = LMerkleRootsStorage.getDeposit(_storage, _rootHash);
&nbsp;
    if (deposit &gt; 0) {
      // TODO: Increase validator's cooling off end time
      address rootHashOwner = LMerkleRootsStorage.getRootHashOwner(_storage, _rootHash);
      LMerkleRootsStorage.setDeposit(_storage, _rootHash, 0);
      LAVTManager.unlockDeposit(_storage, rootHashOwner, deposit);
      LAVTManager.decreaseAVT(_storage, rootHashOwner, deposit);
      LAVTManager.increaseAVT(_storage, msg.sender, deposit);
    }
  }
&nbsp;
  function setLastEventTime(IAventusStorage _storage, bytes32 _rootHash, uint _lastEventTime)
    private
  {
    LMerkleRootsStorage.setLastEventTime(_storage, _rootHash, _lastEventTime);
    uint rootCoolingOffPeriod = LMerkleRootsStorage.getCoolingOffPeriod(_storage);
    LMembers.updateValidatorDeregistrationTimeIfNecessary(_storage, msg.sender, _lastEventTime + rootCoolingOffPeriod);
  }
&nbsp;
  // TODO: Move this to LEvents once listTicket and hence cyclic dependency is removed
  function getEventTime(IAventusStorage _storage, uint _eventId)
    private
    view
    returns (uint eventTime_)
  {
    eventTime_ = _storage.getUInt(keccak256(abi.encodePacked("Event", _eventId, "eventTime")));
  }
&nbsp;
  function max(uint _a, uint _b)
    private
    pure
    returns (uint max_)
  {
    max_ = _a;
&nbsp;
    if (_b &gt; max_) {
      max_ = _b;
    }
  }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Feb 28 2019 12:07:39 GMT+0000 (GMT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
